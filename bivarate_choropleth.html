<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Esri Developer Guide: Relationship</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.32/esri/themes/light/main.css"/>
    <script type="module" src="https://js.arcgis.com/calcite-components/3.0.3/calcite.esm.js"></script>
    <script src="https://js.arcgis.com/4.32/"></script>

    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }

      html, body, #viewDiv, .content-container {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        --calcite-navigation-background-color: #003300;
        --calcite-navigation-logo-heading-text-color: #ffffff;
      }

      calcite-shell {
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      .content-container {
        flex-grow: 1;
        display: flex;
      }

      calcite-panel {
        flex-grow: 1;
        height: 100%;
        display: flex;
      }

      calcite-alert {
            --calcite-alert-background-color: #EDD317;
        }
    </style>

    <script>
      require([
        "esri/views/MapView",
        "esri/WebMap",
        "esri/layers/FeatureLayer",
        "esri/widgets/Legend",
        "esri/widgets/Expand",
        "esri/smartMapping/renderers/relationship",
      ], function (
        MapView,
        WebMap,
        FeatureLayer,
        Legend,
        Expand,
        relationshipRendererCreator
      ) {
        const layer = new FeatureLayer({
          url: "https://services.arcgis.com/YKJ5JtnaPQ2jDbX8/ArcGIS/rest/services/Heat_Vulnerability/FeatureServer",
          blendMode: "multiply",
        });

        const map = new WebMap({
          basemap: 'topo-vector',
          layers: [ layer ]
        });

        const view = new MapView({
          container: "viewDiv",
          map: map,
          zoom: 7,
            center: [ -72.577, 44.260 ],
          // Set dock options on the view's popup
          popup: {
            dockEnabled: true,
            dockOptions: {
              breakpoint: false
            }
          },
          constraints: {
            snapToZoom:false
          }
        });

        view.ui.add(new Expand({
          content: new Legend({
            view
          }),
          view
        }), "top-right");

        layer.when()
          .then(createRelationshipRenderer)
          .then(applyRenderer);

          const [dropdown] = document.getElementsByTagName('calcite-dropdown');
          dropdown.addEventListener("calciteDropdownSelect", () => {
            if (dropdown.selectedItems.length > 2) {
              const lastSelectedItem = dropdown.selectedItems.pop();
              if (lastSelectedItem) {
                lastSelectedItem.selected = false;
              }
              const alertBox = document.getElementById('selection-alert');
              if (alertBox) {
              alertBox.hidden = false;
              }
            }
            if (dropdown.selectedItems.length === 2) {
              const datafield1 = dropdown.selectedItems[0].getAttribute('value');
              const datafield2 = dropdown.selectedItems[1].getAttribute('value');
              createRelationshipRenderer(datafield1, datafield2)
                .then(applyRenderer);}
        });     

    function createRelationshipRenderer(datafield1, datafield2) {

          const params = {
            layer: layer,
            view: view,
            field1: {
              field: datafield1,
              label: datafield1
            },
            field2: {
              field: datafield2,
              label: datafield2
            },
            focus: null,
            numClasses: 3,
            outlineOptimizationEnabled: true
          };

          return relationshipRendererCreator.createRenderer(params);

        }

        function applyRenderer(response) {
          const renderer = response.renderer;


          renderer.uniqueValueInfos.forEach(function (info) {
            switch (info.value) {
              
            }
          });

          layer.renderer = renderer;
        }

      });
    </script>
  </head>
  <body>
    <calcite-shell class="custom-theme">
      <calcite-navigation slot="header">
        <!-- https://www.figma.com/community/file/1360404524550439175 -->
        <calcite-navigation-logo slot="logo" thumbnail="https://www.arcgis.com/sharing/rest/content/items/0ce1e35a117849fdb89822c80ebff64f/resources/MOM-Only-White-128x128-01.png?v=1743270303079" text="Vermont Environmental Justice Map POC" heading="Vermont EJ Map POC"></calcite-navigation-logo>
      </calcite-navigation>
      <div class="content-container">
          <calcite-panel id="viewDiv">
          </calcite-panel>
          <calcite-panel id="dropdown">
            <calcite-dropdown id="data-selector" placeholder="Select two fields to begin mapping" close-on-select-disabled>
              <calcite-button slot="trigger">Select two fields to begin mapping</calcite-button>
              <calcite-dropdown-group group-title="Natural places" selection-mode="multiple" >
                <calcite-dropdown-item value="Pop0_5pct">Population less than 5 years old</calcite-dropdown-item>
                <calcite-dropdown-item value="Pop65Plus">Population 65 years old or older</calcite-dropdown-item>
                <calcite-dropdown-item value="Minority_p">Minority population</calcite-dropdown-item>
                <calcite-dropdown-item value="Poverty_pc">Population living below Federal Poverty Line</calcite-dropdown-item>
                <calcite-dropdown-item value="NoHS_pct">Adult population with no high school diploma</calcite-dropdown-item>
                <calcite-dropdown-item value="Alone65_pc">Adults 65 and older living alone</calcite-dropdown-item>
                <calcite-dropdown-item value="Insure_pct">Adult population with no health insurance</calcite-dropdown-item>
                <calcite-dropdown-item value="Diabetes">Adults with diabetes</calcite-dropdown-item>
                <calcite-dropdown-item value="Asthma">Adults with asthma</calcite-dropdown-item>
                <calcite-dropdown-item value="Hypertensi">Adults with hypertension</calcite-dropdown-item>
                <calcite-dropdown-item value="Obese_pct">Adults who are obese</calcite-dropdown-item>
                <calcite-dropdown-item value="Fair_Poor">Adults in fair or poor health</calcite-dropdown-item>
                <calcite-dropdown-item value="Mortality">All-cause mortality, warm season deaths</calcite-dropdown-item>
                <calcite-dropdown-item value="HouseDenMi">Housing units per square mile</calcite-dropdown-item>
                <calcite-dropdown-item value="Imperv_pct">Land coverage with Impervious surface</calcite-dropdown-item>
                <calcite-dropdown-item value="Forest_Pct">Land coverage by forest canopy</calcite-dropdown-item>
                <calcite-dropdown-item value="Days_gt87">Average number of days per year 87 degrees or hotter</calcite-dropdown-item>
                <calcite-dropdown-item value="ED_Visits">Heat-related emergency department visits</calcite-dropdown-item>
              </calcite-dropdown-group>
          </calcite-dropdown>        
        </calcite-panel>
        <calcite-alert id="selection-alert" kind="brand" label="Selection Alert" open auto-close icon="exclamation-mark-triangle" hidden>
          <div slot="title">Selection Limit Reached</div>
          <div slot="message">You can only select up to 2 fields.</div>
        </calcite-alert>
      </div>
    </calcite-shell>
  </body>
</html>